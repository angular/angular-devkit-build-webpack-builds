"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const index2_1 = require("@angular-devkit/architect/src/index2");
const core_1 = require("@angular-devkit/core");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const webpack = require("webpack");
const WebpackDevServer = require("webpack-dev-server");
const architect_1 = require("../plugins/architect");
const utils_1 = require("../utils");
const webpackMerge = require('webpack-merge');
function runWebpackDevServer(config, context, options = {}) {
    const createWebpack = options.webpackFactory || (config => rxjs_1.of(webpack(config)));
    const log = options.logging
        || ((stats, config) => context.logger.info(stats.toString(config.stats)));
    config = webpackMerge(config, {
        plugins: [
            new architect_1.ArchitectPlugin(context),
        ],
    });
    const devServerConfig = options.devServerConfig || config.devServer || {};
    if (devServerConfig.stats) {
        config.stats = devServerConfig.stats;
    }
    // Disable stats reporting by the devserver, we have our own logger.
    devServerConfig.stats = false;
    return createWebpack(config).pipe(operators_1.switchMap(webpackCompiler => new rxjs_1.Observable(obs => {
        const server = new WebpackDevServer(webpackCompiler, devServerConfig);
        let result;
        webpackCompiler.hooks.done.tap('build-webpack', (stats) => {
            // Log stats.
            log(stats, config);
            obs.next(Object.assign({}, result, { emittedFiles: utils_1.getEmittedFiles(stats.compilation), success: !stats.hasErrors() }));
        });
        server.listen(devServerConfig.port === undefined ? 8080 : devServerConfig.port, devServerConfig.host === undefined ? 'localhost' : devServerConfig.host, function (err) {
            if (err) {
                obs.error(err);
            }
            else {
                const address = this.address();
                result = {
                    success: true,
                    port: typeof address === 'string' ? 0 : address.port,
                    family: typeof address === 'string' ? '' : address.family,
                    address: typeof address === 'string' ? address : address.address,
                };
            }
        });
        // Teardown logic. Close the server when unsubscribed from.
        return () => server.close();
    })));
}
exports.runWebpackDevServer = runWebpackDevServer;
exports.default = index2_1.createBuilder((options, context) => {
    const configPath = core_1.resolve(core_1.normalize(context.workspaceRoot), core_1.normalize(options.webpackConfig));
    return rxjs_1.from(Promise.resolve().then(() => require(core_1.getSystemPath(configPath)))).pipe(operators_1.switchMap((config) => runWebpackDevServer(config, context)));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJwYWNrYWdlcy9hbmd1bGFyX2RldmtpdC9idWlsZF93ZWJwYWNrL3NyYy93ZWJwYWNrLWRldi1zZXJ2ZXIvaW5kZXgyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsaUVBQW9HO0FBQ3BHLCtDQUErRTtBQUUvRSwrQkFBNEM7QUFDNUMsOENBQTJDO0FBQzNDLG1DQUFtQztBQUNuQyx1REFBdUQ7QUFDdkQsb0RBQXVEO0FBQ3ZELG9DQUEyQztBQUkzQyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFTOUMsU0FBZ0IsbUJBQW1CLENBQ2pDLE1BQTZCLEVBQzdCLE9BQXVCLEVBQ3ZCLFVBSUksRUFBRTtJQUVOLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxjQUFjLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLFNBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hGLE1BQU0sR0FBRyxHQUEyQixPQUFPLENBQUMsT0FBTztXQUM5QyxDQUFDLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVFLE1BQU0sR0FBRyxZQUFZLENBQUMsTUFBTSxFQUFFO1FBQzVCLE9BQU8sRUFBRTtZQUNQLElBQUksMkJBQWUsQ0FBQyxPQUFPLENBQUM7U0FDN0I7S0FDRixDQUFDLENBQUM7SUFFSCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsZUFBZSxJQUFJLE1BQU0sQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDO0lBQzFFLElBQUksZUFBZSxDQUFDLEtBQUssRUFBRTtRQUN6QixNQUFNLENBQUMsS0FBSyxHQUFHLGVBQWUsQ0FBQyxLQUE0QyxDQUFDO0tBQzdFO0lBQ0Qsb0VBQW9FO0lBQ3BFLGVBQWUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBRTlCLE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDL0IscUJBQVMsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLElBQUksaUJBQVUsQ0FBdUIsR0FBRyxDQUFDLEVBQUU7UUFDdEUsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDdEUsSUFBSSxNQUE0QixDQUFDO1FBRWpDLGVBQWUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUN4RCxhQUFhO1lBQ2IsR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztZQUVuQixHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUNKLE1BQU0sSUFDVCxZQUFZLEVBQUUsdUJBQWUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQ2hELE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsR0FDTyxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsTUFBTSxDQUNYLGVBQWUsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQ2hFLGVBQWUsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQ3ZFLFVBQTRCLEdBQUc7WUFDN0IsSUFBSSxHQUFHLEVBQUU7Z0JBQ1AsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNoQjtpQkFBTTtnQkFDTCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQy9CLE1BQU0sR0FBRztvQkFDUCxPQUFPLEVBQUUsSUFBSTtvQkFDYixJQUFJLEVBQUUsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJO29CQUNwRCxNQUFNLEVBQUUsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNO29CQUN6RCxPQUFPLEVBQUUsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPO2lCQUNqRSxDQUFDO2FBQ0g7UUFDSCxDQUFDLENBQ0YsQ0FBQztRQUVGLDJEQUEyRDtRQUMzRCxPQUFPLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM5QixDQUFDLENBQUMsQ0FBQyxDQUNKLENBQUM7QUFDSixDQUFDO0FBaEVELGtEQWdFQztBQUdELGtCQUFlLHNCQUFhLENBRTFCLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxFQUFFO0lBQ3JCLE1BQU0sVUFBVSxHQUFHLGNBQU8sQ0FBQyxnQkFBUyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsRUFBRSxnQkFBUyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0lBRS9GLE9BQU8sV0FBSSxzQ0FBUSxvQkFBYSxDQUFDLFVBQVUsQ0FBQyxHQUFFLENBQUMsSUFBSSxDQUNqRCxxQkFBUyxDQUFDLENBQUMsTUFBNkIsRUFBRSxFQUFFLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQ25GLENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbmltcG9ydCB7IEJ1aWxkZXJDb250ZXh0LCBCdWlsZGVyT3V0cHV0LCBjcmVhdGVCdWlsZGVyIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2FyY2hpdGVjdC9zcmMvaW5kZXgyJztcbmltcG9ydCB7IGdldFN5c3RlbVBhdGgsIGpzb24sIG5vcm1hbGl6ZSwgcmVzb2x2ZSB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcbmltcG9ydCAqIGFzIG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCAqIGFzIHdlYnBhY2sgZnJvbSAnd2VicGFjayc7XG5pbXBvcnQgKiBhcyBXZWJwYWNrRGV2U2VydmVyIGZyb20gJ3dlYnBhY2stZGV2LXNlcnZlcic7XG5pbXBvcnQgeyBBcmNoaXRlY3RQbHVnaW4gfSBmcm9tICcuLi9wbHVnaW5zL2FyY2hpdGVjdCc7XG5pbXBvcnQgeyBnZXRFbWl0dGVkRmlsZXMgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBCdWlsZFJlc3VsdCwgV2VicGFja0ZhY3RvcnksIFdlYnBhY2tMb2dnaW5nQ2FsbGJhY2sgfSBmcm9tICcuLi93ZWJwYWNrL2luZGV4Mic7XG5pbXBvcnQgeyBTY2hlbWEgYXMgV2VicGFja0RldlNlcnZlckJ1aWxkZXJTY2hlbWEgfSBmcm9tICcuL3NjaGVtYSc7XG5cbmNvbnN0IHdlYnBhY2tNZXJnZSA9IHJlcXVpcmUoJ3dlYnBhY2stbWVyZ2UnKTtcblxuXG5leHBvcnQgdHlwZSBEZXZTZXJ2ZXJCdWlsZE91dHB1dCA9IEJ1aWxkUmVzdWx0ICYge1xuICBwb3J0OiBudW1iZXI7XG4gIGZhbWlseTogc3RyaW5nO1xuICBhZGRyZXNzOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gcnVuV2VicGFja0RldlNlcnZlcihcbiAgY29uZmlnOiB3ZWJwYWNrLkNvbmZpZ3VyYXRpb24sXG4gIGNvbnRleHQ6IEJ1aWxkZXJDb250ZXh0LFxuICBvcHRpb25zOiB7XG4gICAgZGV2U2VydmVyQ29uZmlnPzogV2VicGFja0RldlNlcnZlci5Db25maWd1cmF0aW9uLFxuICAgIGxvZ2dpbmc/OiBXZWJwYWNrTG9nZ2luZ0NhbGxiYWNrLFxuICAgIHdlYnBhY2tGYWN0b3J5PzogV2VicGFja0ZhY3RvcnksXG4gIH0gPSB7fSxcbik6IE9ic2VydmFibGU8RGV2U2VydmVyQnVpbGRPdXRwdXQ+IHtcbiAgY29uc3QgY3JlYXRlV2VicGFjayA9IG9wdGlvbnMud2VicGFja0ZhY3RvcnkgfHwgKGNvbmZpZyA9PiBvZih3ZWJwYWNrKGNvbmZpZykpKTtcbiAgY29uc3QgbG9nOiBXZWJwYWNrTG9nZ2luZ0NhbGxiYWNrID0gb3B0aW9ucy5sb2dnaW5nXG4gICAgfHwgKChzdGF0cywgY29uZmlnKSA9PiBjb250ZXh0LmxvZ2dlci5pbmZvKHN0YXRzLnRvU3RyaW5nKGNvbmZpZy5zdGF0cykpKTtcblxuICBjb25maWcgPSB3ZWJwYWNrTWVyZ2UoY29uZmlnLCB7XG4gICAgcGx1Z2luczogW1xuICAgICAgbmV3IEFyY2hpdGVjdFBsdWdpbihjb250ZXh0KSxcbiAgICBdLFxuICB9KTtcblxuICBjb25zdCBkZXZTZXJ2ZXJDb25maWcgPSBvcHRpb25zLmRldlNlcnZlckNvbmZpZyB8fCBjb25maWcuZGV2U2VydmVyIHx8IHt9O1xuICBpZiAoZGV2U2VydmVyQ29uZmlnLnN0YXRzKSB7XG4gICAgY29uZmlnLnN0YXRzID0gZGV2U2VydmVyQ29uZmlnLnN0YXRzIGFzIHdlYnBhY2suU3RhdHMuVG9TdHJpbmdPcHRpb25zT2JqZWN0O1xuICB9XG4gIC8vIERpc2FibGUgc3RhdHMgcmVwb3J0aW5nIGJ5IHRoZSBkZXZzZXJ2ZXIsIHdlIGhhdmUgb3VyIG93biBsb2dnZXIuXG4gIGRldlNlcnZlckNvbmZpZy5zdGF0cyA9IGZhbHNlO1xuXG4gIHJldHVybiBjcmVhdGVXZWJwYWNrKGNvbmZpZykucGlwZShcbiAgICBzd2l0Y2hNYXAod2VicGFja0NvbXBpbGVyID0+IG5ldyBPYnNlcnZhYmxlPERldlNlcnZlckJ1aWxkT3V0cHV0PihvYnMgPT4ge1xuICAgICAgY29uc3Qgc2VydmVyID0gbmV3IFdlYnBhY2tEZXZTZXJ2ZXIod2VicGFja0NvbXBpbGVyLCBkZXZTZXJ2ZXJDb25maWcpO1xuICAgICAgbGV0IHJlc3VsdDogRGV2U2VydmVyQnVpbGRPdXRwdXQ7XG5cbiAgICAgIHdlYnBhY2tDb21waWxlci5ob29rcy5kb25lLnRhcCgnYnVpbGQtd2VicGFjaycsIChzdGF0cykgPT4ge1xuICAgICAgICAvLyBMb2cgc3RhdHMuXG4gICAgICAgIGxvZyhzdGF0cywgY29uZmlnKTtcblxuICAgICAgICBvYnMubmV4dCh7XG4gICAgICAgICAgLi4ucmVzdWx0LFxuICAgICAgICAgIGVtaXR0ZWRGaWxlczogZ2V0RW1pdHRlZEZpbGVzKHN0YXRzLmNvbXBpbGF0aW9uKSxcbiAgICAgICAgICBzdWNjZXNzOiAhc3RhdHMuaGFzRXJyb3JzKCksXG4gICAgICAgIH0gYXMgdW5rbm93biBhcyBEZXZTZXJ2ZXJCdWlsZE91dHB1dCk7XG4gICAgICB9KTtcblxuICAgICAgc2VydmVyLmxpc3RlbihcbiAgICAgICAgZGV2U2VydmVyQ29uZmlnLnBvcnQgPT09IHVuZGVmaW5lZCA/IDgwODAgOiBkZXZTZXJ2ZXJDb25maWcucG9ydCxcbiAgICAgICAgZGV2U2VydmVyQ29uZmlnLmhvc3QgPT09IHVuZGVmaW5lZCA/ICdsb2NhbGhvc3QnIDogZGV2U2VydmVyQ29uZmlnLmhvc3QsXG4gICAgICAgIGZ1bmN0aW9uICh0aGlzOiBuZXQuU2VydmVyLCBlcnIpIHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBvYnMuZXJyb3IoZXJyKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IHRoaXMuYWRkcmVzcygpO1xuICAgICAgICAgICAgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICBwb3J0OiB0eXBlb2YgYWRkcmVzcyA9PT0gJ3N0cmluZycgPyAwIDogYWRkcmVzcy5wb3J0LFxuICAgICAgICAgICAgICBmYW1pbHk6IHR5cGVvZiBhZGRyZXNzID09PSAnc3RyaW5nJyA/ICcnIDogYWRkcmVzcy5mYW1pbHksXG4gICAgICAgICAgICAgIGFkZHJlc3M6IHR5cGVvZiBhZGRyZXNzID09PSAnc3RyaW5nJyA/IGFkZHJlc3MgOiBhZGRyZXNzLmFkZHJlc3MsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFRlYXJkb3duIGxvZ2ljLiBDbG9zZSB0aGUgc2VydmVyIHdoZW4gdW5zdWJzY3JpYmVkIGZyb20uXG4gICAgICByZXR1cm4gKCkgPT4gc2VydmVyLmNsb3NlKCk7XG4gICAgfSkpLFxuICApO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZUJ1aWxkZXI8XG4gIGpzb24uSnNvbk9iamVjdCAmIFdlYnBhY2tEZXZTZXJ2ZXJCdWlsZGVyU2NoZW1hLCBEZXZTZXJ2ZXJCdWlsZE91dHB1dFxuPigob3B0aW9ucywgY29udGV4dCkgPT4ge1xuICBjb25zdCBjb25maWdQYXRoID0gcmVzb2x2ZShub3JtYWxpemUoY29udGV4dC53b3Jrc3BhY2VSb290KSwgbm9ybWFsaXplKG9wdGlvbnMud2VicGFja0NvbmZpZykpO1xuXG4gIHJldHVybiBmcm9tKGltcG9ydChnZXRTeXN0ZW1QYXRoKGNvbmZpZ1BhdGgpKSkucGlwZShcbiAgICBzd2l0Y2hNYXAoKGNvbmZpZzogd2VicGFjay5Db25maWd1cmF0aW9uKSA9PiBydW5XZWJwYWNrRGV2U2VydmVyKGNvbmZpZywgY29udGV4dCkpLFxuICApO1xufSk7XG4iXX0=