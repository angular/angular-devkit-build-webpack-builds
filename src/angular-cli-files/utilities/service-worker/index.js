"use strict";
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
Object.defineProperty(exports, "__esModule", { value: true });
const common_tags_1 = require("common-tags");
const crypto = require("crypto");
const fs = require("fs");
const path = require("path");
const semver = require("semver");
const require_project_module_1 = require("../require-project-module");
exports.NEW_SW_VERSION = '5.0.0-rc.0';
class CliFilesystem {
    constructor(base) {
        this.base = base;
    }
    list(_path) {
        return Promise.resolve(this.syncList(_path));
    }
    syncList(_path) {
        const dir = this.canonical(_path);
        const entries = fs.readdirSync(dir).map((entry) => ({ entry, stats: fs.statSync(path.posix.join(dir, entry)) }));
        const files = entries.filter((entry) => !entry.stats.isDirectory())
            .map((entry) => path.posix.join(_path, entry.entry));
        return entries.filter((entry) => entry.stats.isDirectory())
            .map((entry) => path.posix.join(_path, entry.entry))
            .reduce((list, subdir) => list.concat(this.syncList(subdir)), files);
    }
    read(_path) {
        const file = this.canonical(_path);
        return Promise.resolve(fs.readFileSync(file).toString());
    }
    hash(_path) {
        const sha1 = crypto.createHash('sha1');
        const file = this.canonical(_path);
        const contents = fs.readFileSync(file);
        sha1.update(contents);
        return Promise.resolve(sha1.digest('hex'));
    }
    write(_path, contents) {
        const file = this.canonical(_path);
        fs.writeFileSync(file, contents);
        return Promise.resolve();
    }
    canonical(_path) { return path.posix.join(this.base, _path); }
}
function usesServiceWorker(projectRoot) {
    let swPackageJsonPath;
    try {
        swPackageJsonPath = require_project_module_1.resolveProjectModule(projectRoot, '@angular/service-worker/package.json');
    }
    catch (_) {
        // @angular/service-worker is not installed
        throw new Error(common_tags_1.stripIndent `
    Your project is configured with serviceWorker = true, but @angular/service-worker
    is not installed. Run \`npm install --save-dev @angular/service-worker\`
    and try again, or run \`ng set apps.0.serviceWorker=false\` in your .angular-cli.json.
  `);
    }
    const swPackageJson = fs.readFileSync(swPackageJsonPath).toString();
    const swVersion = JSON.parse(swPackageJson)['version'];
    if (!semver.gte(swVersion, exports.NEW_SW_VERSION)) {
        throw new Error(common_tags_1.stripIndent `
    The installed version of @angular/service-worker is ${swVersion}. This version of the CLI
    requires the @angular/service-worker version to satisfy ${exports.NEW_SW_VERSION}. Please upgrade
    your service worker version.
  `);
    }
    return true;
}
exports.usesServiceWorker = usesServiceWorker;
function augmentAppWithServiceWorker(projectRoot, appRoot, outputPath, baseHref) {
    // Path to the worker script itself.
    const workerPath = require_project_module_1.resolveProjectModule(projectRoot, '@angular/service-worker/ngsw-worker.js');
    const safetyPath = path.join(path.dirname(workerPath), 'safety-worker.js');
    const configPath = path.resolve(appRoot, 'ngsw-config.json');
    if (!fs.existsSync(configPath)) {
        throw new Error(common_tags_1.oneLine `Error: Expected to find an ngsw-config.json configuration
      file in the ${appRoot} folder. Either provide one or disable Service Worker
      in .angular-cli.json.`);
    }
    const config = fs.readFileSync(configPath, 'utf8');
    const Generator = require('@angular/service-worker/config').Generator;
    const gen = new Generator(new CliFilesystem(outputPath), baseHref);
    return gen
        .process(JSON.parse(config))
        .then((output) => {
        const manifest = JSON.stringify(output, null, 2);
        fs.writeFileSync(path.resolve(outputPath, 'ngsw.json'), manifest);
        // Copy worker script to dist directory.
        const workerCode = fs.readFileSync(workerPath);
        fs.writeFileSync(path.resolve(outputPath, 'ngsw-worker.js'), workerCode);
        // If @angular/service-worker has the safety script, copy it into two locations.
        if (fs.existsSync(safetyPath)) {
            const safetyCode = fs.readFileSync(safetyPath);
            fs.writeFileSync(path.resolve(outputPath, 'worker-basic.min.js'), safetyCode);
            fs.writeFileSync(path.resolve(outputPath, 'safety-worker.js'), safetyCode);
        }
    });
}
exports.augmentAppWithServiceWorker = augmentAppWithServiceWorker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L2J1aWxkX3dlYnBhY2svc3JjL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9zZXJ2aWNlLXdvcmtlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsaUJBQWlCO0FBQ2pCLCtEQUErRDs7QUFHL0QsNkNBQW1EO0FBQ25ELGlDQUFpQztBQUNqQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLGlDQUFpQztBQUVqQyxzRUFBaUU7QUFFcEQsUUFBQSxjQUFjLEdBQUcsWUFBWSxDQUFDO0FBRTNDO0lBQ0UsWUFBb0IsSUFBWTtRQUFaLFNBQUksR0FBSixJQUFJLENBQVE7SUFBSSxDQUFDO0lBRXJDLElBQUksQ0FBQyxLQUFhO1FBQ2hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU8sUUFBUSxDQUFDLEtBQWE7UUFDNUIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQyxNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FDckMsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbkYsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO2FBQ3JFLEdBQUcsQ0FBQyxDQUFD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VSxFQUFFLFdBQVcsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2xFLHdDQUF3QztRQUN4QyxNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9DLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUV6RSxnRkFBZ0Y7UUFDaEYsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMvQyxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLHFCQUFxQixDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDOUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxrQkFBa0IsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzdFLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFoQ0Qsa0VBZ0NDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGVcbi8vIFRPRE86IGNsZWFudXAgdGhpcyBmaWxlLCBpdCdzIGNvcGllZCBhcyBpcyBmcm9tIEFuZ3VsYXIgQ0xJLlxuXG5pbXBvcnQgeyBGaWxlc3lzdGVtIH0gZnJvbSAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvY29uZmlnJztcbmltcG9ydCB7IG9uZUxpbmUsIHN0cmlwSW5kZW50IH0gZnJvbSAnY29tbW9uLXRhZ3MnO1xuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cbmltcG9ydCB7IHJlc29sdmVQcm9qZWN0TW9kdWxlIH0gZnJvbSAnLi4vcmVxdWlyZS1wcm9qZWN0LW1vZHVsZSc7XG5cbmV4cG9ydCBjb25zdCBORVdfU1dfVkVSU0lPTiA9ICc1LjAuMC1yYy4wJztcblxuY2xhc3MgQ2xpRmlsZXN5c3RlbSBpbXBsZW1lbnRzIEZpbGVzeXN0ZW0ge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGJhc2U6IHN0cmluZykgeyB9XG5cbiAgbGlzdChfcGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5zeW5jTGlzdChfcGF0aCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBzeW5jTGlzdChfcGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGRpciA9IHRoaXMuY2Fub25pY2FsKF9wYXRoKTtcbiAgICBjb25zdCBlbnRyaWVzID0gZnMucmVhZGRpclN5bmMoZGlyKS5tYXAoXG4gICAgICAoZW50cnk6IHN0cmluZykgPT4gKHsgZW50cnksIHN0YXRzOiBmcy5zdGF0U3luYyhwYXRoLnBvc2l4LmpvaW4oZGlyLCBlbnRyeSkpIH0pKTtcbiAgICBjb25zdCBmaWxlcyA9IGVudHJpZXMuZmlsdGVyKChlbnRyeTogYW55KSA9PiAhZW50cnkuc3RhdHMuaXNEaXJlY3RvcnkoKSlcbiAgICAgIC5tYXAoKGVudHJ5OiBhbnkpID0+IHBhdGgucG9zaXguam9pbihfcGF0aCwgZW50cnkuZW50cnkpKTtcblxuICAgIHJldHVybiBlbnRyaWVzLmZpbHRlcigoZW50cnk6IGFueSkgPT4gZW50cnkuc3RhdHMuaXNEaXJlY3RvcnkoKSlcbiAgICAgIC5tYXAoKGVudHJ5OiBhbnkpID0+IHBhdGgucG9zaXguam9pbihfcGF0aCwgZW50cnkuZW50cnkpKVxuICAgICAgLnJlZHVjZSgobGlzdDogc3RyaW5nW10sIHN1YmRpcjogc3RyaW5nKSA9PiBsaXN0LmNvbmNhdCh0aGlzLnN5bmNMaXN0KHN1YmRpcikpLCBmaWxlcyk7XG4gIH1cblxuICByZWFkKF9wYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGZpbGUgPSB0aGlzLmNhbm9uaWNhbChfcGF0aCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmcy5yZWFkRmlsZVN5bmMoZmlsZSkudG9TdHJpbmcoKSk7XG4gIH1cblxuICBoYXNoKF9wYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNoYTEgPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpO1xuICAgIGNvbnN0IGZpbGUgPSB0aGlzLmNhbm9uaWNhbChfcGF0aCk7XG4gICAgY29uc3QgY29udGVudHM6IEJ1ZmZlciA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTtcbiAgICBzaGExLnVwZGF0ZShjb250ZW50cyk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzaGExLmRpZ2VzdCgnaGV4JykpO1xuICB9XG5cbiAgd3JpdGUoX3BhdGg6IHN0cmluZywgY29udGVudHM6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGZpbGUgPSB0aGlzLmNhbm9uaWNhbChfcGF0aCk7XG4gICAgZnMud3JpdGVGaWxlU3luYyhmaWxlLCBjb250ZW50cyk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5vbmljYWwoX3BhdGg6IHN0cmluZyk6IHN0cmluZyB7IHJldHVybiBwYXRoLnBvc2l4LmpvaW4odGhpcy5iYXNlLCBfcGF0aCk7IH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZXNTZXJ2aWNlV29ya2VyKHByb2plY3RSb290OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgbGV0IHN3UGFja2FnZUpzb25QYXRoO1xuXG4gIHRyeSB7XG4gICAgc3dQYWNrYWdlSnNvblBhdGggPSByZXNvbHZlUHJvamVjdE1vZHVsZShwcm9qZWN0Um9vdCwgJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL3BhY2thZ2UuanNvbicpO1xuICB9IGNhdGNoIChfKSB7XG4gICAgLy8gQGFuZ3VsYXIvc2VydmljZS13b3JrZXIgaXMgbm90IGluc3RhbGxlZFxuICAgIHRocm93IG5ldyBFcnJvcihzdHJpcEluZGVudGBcbiAgICBZb3VyIHByb2plY3QgaXMgY29uZmlndXJlZCB3aXRoIHNlcnZpY2VXb3JrZXIgPSB0cnVlLCBidXQgQGFuZ3VsYXIvc2VydmljZS13b3JrZXJcbiAgICBpcyBub3QgaW5zdGFsbGVkLiBSdW4gXFxgbnBtIGluc3RhbGwgLS1zYXZlLWRldiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlclxcYFxuICAgIGFuZCB0cnkgYWdhaW4sIG9yIHJ1biBcXGBuZyBzZXQgYXBwcy4wLnNlcnZpY2VXb3JrZXI9ZmFsc2VcXGAgaW4geW91ciAuYW5ndWxhci1jbGkuanNvbi5cbiAgYCk7XG4gIH1cblxuICBjb25zdCBzd1BhY2thZ2VKc29uID0gZnMucmVhZEZpbGVTeW5jKHN3UGFja2FnZUpzb25QYXRoKS50b1N0cmluZygpO1xuICBjb25zdCBzd1ZlcnNpb24gPSBKU09OLnBhcnNlKHN3UGFja2FnZUpzb24pWyd2ZXJzaW9uJ107XG5cbiAgaWYgKCFzZW12ZXIuZ3RlKHN3VmVyc2lvbiwgTkVXX1NXX1ZFUlNJT04pKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKHN0cmlwSW5kZW50YFxuICAgIFRoZSBpbnN0YWxsZWQgdmVyc2lvbiBvZiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBpcyAke3N3VmVyc2lvbn0uIFRoaXMgdmVyc2lvbiBvZiB0aGUgQ0xJXG4gICAgcmVxdWlyZXMgdGhlIEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyIHZlcnNpb24gdG8gc2F0aXNmeSAke05FV19TV19WRVJTSU9OfS4gUGxlYXNlIHVwZ3JhZGVcbiAgICB5b3VyIHNlcnZpY2Ugd29ya2VyIHZlcnNpb24uXG4gIGApO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdWdtZW50QXBwV2l0aFNlcnZpY2VXb3JrZXIocHJvamVjdFJvb3Q6IHN0cmluZywgYXBwUm9vdDogc3RyaW5nLFxuICBvdXRwdXRQYXRoOiBzdHJpbmcsIGJhc2VIcmVmOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgLy8gUGF0aCB0byB0aGUgd29ya2VyIHNjcmlwdCBpdHNlbGYuXG4gIGNvbnN0IHdvcmtlclBhdGggPSByZXNvbHZlUHJvamVjdE1vZHVsZShwcm9qZWN0Um9vdCwgJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL25nc3ctd29ya2VyLmpzJyk7XG4gIGNvbnN0IHNhZmV0eVBhdGggPSBwYXRoLmpvaW4ocGF0aC5kaXJuYW1lKHdvcmtlclBhdGgpLCAnc2FmZXR5LXdvcmtlci5qcycpO1xuICBjb25zdCBjb25maWdQYXRoID0gcGF0aC5yZXNvbHZlKGFwcFJvb3QsICduZ3N3LWNvbmZpZy5qc29uJyk7XG5cbiAgaWYgKCFmcy5leGlzdHNTeW5jKGNvbmZpZ1BhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKG9uZUxpbmVgRXJyb3I6IEV4cGVjdGVkIHRvIGZpbmQgYW4gbmdzdy1jb25maWcuanNvbiBjb25maWd1cmF0aW9uXG4gICAgICBmaWxlIGluIHRoZSAke2FwcFJvb3R9IGZvbGRlci4gRWl0aGVyIHByb3ZpZGUgb25lIG9yIGRpc2FibGUgU2VydmljZSBXb3JrZXJcbiAgICAgIGluIC5hbmd1bGFyLWNsaS5qc29uLmApO1xuICB9XG4gIGNvbnN0IGNvbmZpZyA9IGZzLnJlYWRGaWxlU3luYyhjb25maWdQYXRoLCAndXRmOCcpO1xuXG4gIGNvbnN0IEdlbmVyYXRvciA9IHJlcXVpcmUoJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL2NvbmZpZycpLkdlbmVyYXRvcjtcbiAgY29uc3QgZ2VuID0gbmV3IEdlbmVyYXRvcihuZXcgQ2xpRmlsZXN5c3RlbShvdXRwdXRQYXRoKSwgYmFzZUhyZWYpO1xuICByZXR1cm4gZ2VuXG4gICAgLnByb2Nlc3MoSlNPTi5wYXJzZShjb25maWcpKVxuICAgIC50aGVuKChvdXRwdXQ6IE9iamVjdCkgPT4ge1xuICAgICAgY29uc3QgbWFuaWZlc3QgPSBKU09OLnN0cmluZ2lmeShvdXRwdXQsIG51bGwsIDIpO1xuICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLnJlc29sdmUob3V0cHV0UGF0aCwgJ25nc3cuanNvbicpLCBtYW5pZmVzdCk7XG4gICAgICAvLyBDb3B5IHdvcmtlciBzY3JpcHQgdG8gZGlzdCBkaXJlY3RvcnkuXG4gICAgICBjb25zdCB3b3JrZXJDb2RlID0gZnMucmVhZEZpbGVTeW5jKHdvcmtlclBhdGgpO1xuICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLnJlc29sdmUob3V0cHV0UGF0aCwgJ25nc3ctd29ya2VyLmpzJyksIHdvcmtlckNvZGUpO1xuXG4gICAgICAvLyBJZiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBoYXMgdGhlIHNhZmV0eSBzY3JpcHQsIGNvcHkgaXQgaW50byB0d28gbG9jYXRpb25zLlxuICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoc2FmZXR5UGF0aCkpIHtcbiAgICAgICAgY29uc3Qgc2FmZXR5Q29kZSA9IGZzLnJlYWRGaWxlU3luYyhzYWZldHlQYXRoKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLnJlc29sdmUob3V0cHV0UGF0aCwgJ3dvcmtlci1iYXNpYy5taW4uanMnKSwgc2FmZXR5Q29kZSk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5yZXNvbHZlKG91dHB1dFBhdGgsICdzYWZldHktd29ya2VyLmpzJyksIHNhZmV0eUNvZGUpO1xuICAgICAgfVxuICAgIH0pO1xufVxuIl19