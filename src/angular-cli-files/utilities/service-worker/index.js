"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
const core_1 = require("@angular-devkit/core");
const common_tags_1 = require("common-tags");
const crypto = require("crypto");
const fs = require("fs");
const semver = require("semver");
const require_project_module_1 = require("../require-project-module");
const operators_1 = require("rxjs/operators");
const merge_1 = require("rxjs/observable/merge");
const of_1 = require("rxjs/observable/of");
exports.NEW_SW_VERSION = '5.0.0-rc.0';
class CliFilesystem {
    constructor(_host, base) {
        this._host = _host;
        this.base = base;
    }
    list(path) {
        return this._host.list(this._resolve(path)).toPromise().then(x => x, _err => []);
    }
    read(path) {
        return this._host.read(this._resolve(path))
            .toPromise()
            .then(content => core_1.virtualFs.fileBufferToString(content));
    }
    hash(path) {
        const sha1 = crypto.createHash('sha1');
        return this.read(path)
            .then(content => sha1.update(content))
            .then(() => sha1.digest('hex'));
    }
    write(path, content) {
        return this._host.write(this._resolve(path), core_1.virtualFs.stringToFileBuffer(content))
            .toPromise();
    }
    _resolve(path) {
        return core_1.join(core_1.normalize(this.base), path);
    }
}
function usesServiceWorker(projectRoot) {
    let swPackageJsonPath;
    try {
        swPackageJsonPath = require_project_module_1.resolveProjectModule(projectRoot, '@angular/service-worker/package.json');
    }
    catch (_) {
        // @angular/service-worker is not installed
        throw new Error(common_tags_1.stripIndent `
    Your project is configured with serviceWorker = true, but @angular/service-worker
    is not installed. Run \`npm install --save-dev @angular/service-worker\`
    and try again, or run \`ng set apps.0.serviceWorker=false\` in your .angular-cli.json.
  `);
    }
    const swPackageJson = fs.readFileSync(swPackageJsonPath).toString();
    const swVersion = JSON.parse(swPackageJson)['version'];
    if (!semver.gte(swVersion, exports.NEW_SW_VERSION)) {
        throw new Error(common_tags_1.stripIndent `
    The installed version of @angular/service-worker is ${swVersion}. This version of the CLI
    requires the @angular/service-worker version to satisfy ${exports.NEW_SW_VERSION}. Please upgrade
    your service worker version.
  `);
    }
    return true;
}
exports.usesServiceWorker = usesServiceWorker;
function augmentAppWithServiceWorker(host, projectRoot, appRoot, outputPath, baseHref) {
    // Path to the worker script itself.
    const distPath = core_1.normalize(outputPath);
    const workerPath = core_1.normalize(require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/ngsw-worker.js'));
    const swConfigPath = require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/config');
    const safetyPath = core_1.join(core_1.dirname(workerPath), 'safety-worker.js');
    const configPath = core_1.join(appRoot, 'ngsw-config.json');
    return host.exists(configPath).pipe(operators_1.switchMap(exists => {
        if (!exists) {
            throw new Error(common_tags_1.oneLine `
          Error: Expected to find an ngsw-config.json configuration
          file in the ${appRoot} folder. Either provide one or disable Service Worker
          in your angular.json configuration file.`);
        }
        return host.read(configPath);
    }), operators_1.map(content => JSON.parse(core_1.virtualFs.fileBufferToString(content))), operators_1.switchMap(configJson => {
        const Generator = require(swConfigPath).Generator;
        const gen = new Generator(new CliFilesystem(host, outputPath), baseHref);
        return gen.process(configJson);
    }), operators_1.switchMap(output => {
        const manifest = JSON.stringify(output, null, 2);
        return host.read(workerPath).pipe(operators_1.switchMap(workerCode => {
            return merge_1.merge(host.write(core_1.join(distPath, 'ngsw.json'), core_1.virtualFs.stringToFileBuffer(manifest)), host.write(core_1.join(distPath, 'ngsw-worker.js'), workerCode));
        }));
    }), operators_1.switchMap(() => host.exists(safetyPath)), 
    // If @angular/service-worker has the safety script, copy it into two locations.
    operators_1.switchMap(exists => {
        if (!exists) {
            return of_1.of(undefined);
        }
        return host.read(safetyPath).pipe(operators_1.switchMap(safetyCode => {
            return merge_1.merge(host.write(core_1.join(distPath, 'worker-basic.min.js'), safetyCode), host.write(core_1.join(distPath, 'safety-worker.js'), safetyCode));
        }));
    }), 
    // Remove all elements, reduce them to a single emit.
    operators_1.reduce(() => { })).toPromise();
}
exports.augmentAppWithServiceWorker = augmentAppWithServiceWorker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L2J1aWxkX3dlYnBhY2svc3JjL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9zZXJ2aWNlLXdvcmtlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlCQUFpQjtBQUNqQiwrREFBK0Q7QUFDL0QsK0NBQWdHO0FBRWhHLDZDQUFtRDtBQUNuRCxpQ0FBaUM7QUFDakMseUJBQXlCO0FBQ3pCLGlDQUFpQztBQUVqQyxzRUFBaUU7QUFDakUsOENBQXdEO0FBRXhELGlEQUE4QztBQUM5QywyQ0FBd0M7QUFHM0IsUUFBQSxjQUFjLEdBQUcsWUFBWSxDQUFDO0FBRzNDO0lBQ0UsWUFBb0IsS0FBcUIsRUFBVSxJQUFZO1FBQTNDLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBUTtJQUFJLENBQUM7SUFFcEUsSUFBSSxDQUFDLElBQVk7UUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ25GLENBQUM7SUFFRCxJQUFJLENBQUMsSUFBWTtRQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3hDLFNBQVMsRUFBRTthQUNYLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLGdCQUFTLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsSUFBSSxDQUFDLElBQVk7UUFDZixNQUFNLElBQUksR0FB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aEYscUJBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUNqQixFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWixNQUFNLENBQUMsT0FBRSxDQUFPLFNBQVMsQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQy9CLHFCQUFTLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDckIsTUFBTSxDQUFDLGFBQUssQ0FDVixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQUksQ0FBQyxRQUFRLEVBQUUscUJBQXFCLENBQUMsRUFBRSxVQUFVLENBQUMsRUFDN0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFJLENBQUMsUUFBUSxFQUFFLGtCQUFrQixDQUFDLEVBQUUsVUFBVSxDQUFDLENBQ3ZDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLHFEQUFxRDtJQUNyRCxrQkFBTSxDQUFDLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUNqQixDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ2hCLENBQUM7QUF2RUQsa0VBdUVDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGVcbi8vIFRPRE86IGNsZWFudXAgdGhpcyBmaWxlLCBpdCdzIGNvcGllZCBhcyBpcyBmcm9tIEFuZ3VsYXIgQ0xJLlxuaW1wb3J0IHsgUGF0aCwgam9pbiwgbm9ybWFsaXplLCB2aXJ0dWFsRnMsIGRpcm5hbWUsIGdldFN5c3RlbVBhdGggfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgeyBGaWxlc3lzdGVtIH0gZnJvbSAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvY29uZmlnJztcbmltcG9ydCB7IG9uZUxpbmUsIHN0cmlwSW5kZW50IH0gZnJvbSAnY29tbW9uLXRhZ3MnO1xuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuaW1wb3J0IHsgcmVzb2x2ZVByb2plY3RNb2R1bGUgfSBmcm9tICcuLi9yZXF1aXJlLXByb2plY3QtbW9kdWxlJztcbmltcG9ydCB7IG1hcCwgcmVkdWNlLCBzd2l0Y2hNYXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tIFwicnhqcy9vYnNlcnZhYmxlL21lcmdlXCI7XG5pbXBvcnQgeyBvZiB9IGZyb20gXCJyeGpzL29ic2VydmFibGUvb2ZcIjtcblxuXG5leHBvcnQgY29uc3QgTkVXX1NXX1ZFUlNJT04gPSAnNS4wLjAtcmMuMCc7XG5cblxuY2xhc3MgQ2xpRmlsZXN5c3RlbSBpbXBsZW1lbnRzIEZpbGVzeXN0ZW0ge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9ob3N0OiB2aXJ0dWFsRnMuSG9zdCwgcHJpdmF0ZSBiYXNlOiBzdHJpbmcpIHsgfVxuXG4gIGxpc3QocGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiB0aGlzLl9ob3N0Lmxpc3QodGhpcy5fcmVzb2x2ZShwYXRoKSkudG9Qcm9taXNlKCkudGhlbih4ID0+IHgsIF9lcnIgPT4gW10pO1xuICB9XG5cbiAgcmVhZChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLl9ob3N0LnJlYWQodGhpcy5fcmVzb2x2ZShwYXRoKSlcbiAgICAgIC50b1Byb21pc2UoKVxuICAgICAgLnRoZW4oY29udGVudCA9PiB2aXJ0dWFsRnMuZmlsZUJ1ZmZlclRvU3RyaW5nKGNvbnRlbnQpKTtcbiAgfVxuXG4gIGhhc2gocGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBzaGExID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTEnKTtcblxuICAgIHJldHVybiB0aGlzLnJlYWQocGF0aClcbiAgICAgIC50aGVuKGNvbnRlbnQgPT4gc2hhMS51cGRhdGUoY29udGVudCkpXG4gICAgICAudGhlbigoKSA9PiBzaGExLmRpZ2VzdCgnaGV4JykpO1xuICB9XG5cbiAgd3JpdGUocGF0aDogc3RyaW5nLCBjb250ZW50OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5faG9zdC53cml0ZSh0aGlzLl9yZXNvbHZlKHBhdGgpLCB2aXJ0dWFsRnMuc3RyaW5nVG9GaWxlQnVmZmVyKGNvbnRlbnQpKVxuICAgICAgLnRvUHJvbWlzZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVzb2x2ZShwYXRoOiBzdHJpbmcpOiBQYXRoIHtcbiAgICByZXR1cm4gam9pbihub3JtYWxpemUodGhpcy5iYXNlKSwgcGF0aCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZXNTZXJ2aWNlV29ya2VyKHByb2plY3RSb290OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgbGV0IHN3UGFja2FnZUpzb25QYXRoO1xuXG4gIHRyeSB7XG4gICAgc3dQYWNrYWdlSnNvblBhdGggPSByZXNvbHZlUHJvamVjdE1vZHVsZShwcm9qZWN0Um9vdCwgJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL3BhY2thZ2UuanNvbicpO1xuICB9IGNhdGNoIChfKSB7XG4gICAgLy8gQGFuZ3VsYXIvc2VydmljZS13b3JrZXIgaXMgbm90IGluc3RhbGxlZFxuICAgIHRocm93IG5ldyBFcnJvcihzdHJpcEluZGVudGBcbiAgICBZb3VyIHByb2plY3QgaXMgY29uZmlndXJlZCB3aXRoIHNlcnZpY2VXb3JrZXIgPSB0cnVlLCBidXQgQGFuZ3VsYXIvc2VydmljZS13b3JrZXJcbiAgICBpcyBub3QgaW5zdGFsbGVkLiBSdW4gXFxgbnBtIGluc3RhbGwgLS1zYXZlLWRldiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlclxcYFxuICAgIGFuZCB0cnkgYWdhaW4sIG9yIHJ1biBcXGBuZyBzZXQgYXBwcy4wLnNlcnZpY2VXb3JrZXI9ZmFsc2VcXGAgaW4geW91ciAuYW5ndWxhci1jbGkuanNvbi5cbiAgYCk7XG4gIH1cblxuICBjb25zdCBzd1BhY2thZ2VKc29uID0gZnMucmVhZEZpbGVTeW5jKHN3UGFja2FnZUpzb25QYXRoKS50b1N0cmluZygpO1xuICBjb25zdCBzd1ZlcnNpb24gPSBKU09OLnBhcnNlKHN3UGFja2FnZUpzb24pWyd2ZXJzaW9uJ107XG5cbiAgaWYgKCFzZW12ZXIuZ3RlKHN3VmVyc2lvbiwgTkVXX1NXX1ZFUlNJT04pKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKHN0cmlwSW5kZW50YFxuICAgIFRoZSBpbnN0YWxsZWQgdmVyc2lvbiBvZiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBpcyAke3N3VmVyc2lvbn0uIFRoaXMgdmVyc2lvbiBvZiB0aGUgQ0xJXG4gICAgcmVxdWlyZXMgdGhlIEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyIHZlcnNpb24gdG8gc2F0aXNmeSAke05FV19TV19WRVJTSU9OfS4gUGxlYXNlIHVwZ3JhZGVcbiAgICB5b3VyIHNlcnZpY2Ugd29ya2VyIHZlcnNpb24uXG4gIGApO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdWdtZW50QXBwV2l0aFNlcnZpY2VXb3JrZXIoXG4gIGhvc3Q6IHZpcnR1YWxGcy5Ib3N0LFxuICBwcm9qZWN0Um9vdDogUGF0aCxcbiAgYXBwUm9vdDogUGF0aCxcbiAgb3V0cHV0UGF0aDogUGF0aCxcbiAgYmFzZUhyZWY6IHN0cmluZyxcbik6IFByb21pc2U8dm9pZD4ge1xuICAvLyBQYXRoIHRvIHRoZSB3b3JrZXIgc2NyaXB0IGl0c2VsZi5cbiAgY29uc3QgZGlzdFBhdGggPSBub3JtYWxpemUob3V0cHV0UGF0aCk7XG4gIGNvbnN0IHdvcmtlclBhdGggPSBub3JtYWxpemUoXG4gICAgcmVzb2x2ZVByb2plY3RNb2R1bGUoZ2V0U3lzdGVtUGF0aChwcm9qZWN0Um9vdCksICdAYW5ndWxhci9zZXJ2aWNlLXdvcmtlci9uZ3N3LXdvcmtlci5qcycpLFxuICApO1xuICBjb25zdCBzd0NvbmZpZ1BhdGggPSByZXNvbHZlUHJvamVjdE1vZHVsZShcbiAgICBnZXRTeXN0ZW1QYXRoKHByb2plY3RSb290KSxcbiAgICAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvY29uZmlnJyxcbiAgKTtcbiAgY29uc3Qgc2FmZXR5UGF0aCA9IGpvaW4oZGlybmFtZSh3b3JrZXJQYXRoKSwgJ3NhZmV0eS13b3JrZXIuanMnKTtcbiAgY29uc3QgY29uZmlnUGF0aCA9IGpvaW4oYXBwUm9vdCwgJ25nc3ctY29uZmlnLmpzb24nKTtcblxuICByZXR1cm4gaG9zdC5leGlzdHMoY29uZmlnUGF0aCkucGlwZShcbiAgICBzd2l0Y2hNYXAoZXhpc3RzID0+IHtcbiAgICAgIGlmICghZXhpc3RzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihvbmVMaW5lYFxuICAgICAgICAgIEVycm9yOiBFeHBlY3RlZCB0byBmaW5kIGFuIG5nc3ctY29uZmlnLmpzb24gY29uZmlndXJhdGlvblxuICAgICAgICAgIGZpbGUgaW4gdGhlICR7YXBwUm9vdH0gZm9sZGVyLiBFaXRoZXIgcHJvdmlkZSBvbmUgb3IgZGlzYWJsZSBTZXJ2aWNlIFdvcmtlclxuICAgICAgICAgIGluIHlvdXIgYW5ndWxhci5qc29uIGNvbmZpZ3VyYXRpb24gZmlsZS5gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaG9zdC5yZWFkKGNvbmZpZ1BhdGgpIGFzIE9ic2VydmFibGU8dmlydHVhbEZzLkZpbGVCdWZmZXI+O1xuICAgIH0pLFxuICAgIG1hcChjb250ZW50ID0+IEpTT04ucGFyc2UodmlydHVhbEZzLmZpbGVCdWZmZXJUb1N0cmluZyhjb250ZW50KSkpLFxuICAgIHN3aXRjaE1hcChjb25maWdKc29uID0+IHtcbiAgICAgIGNvbnN0IEdlbmVyYXRvciA9IHJlcXVpcmUoc3dDb25maWdQYXRoKS5HZW5lcmF0b3I7XG4gICAgICBjb25zdCBnZW4gPSBuZXcgR2VuZXJhdG9yKG5ldyBDbGlGaWxlc3lzdGVtKGhvc3QsIG91dHB1dFBhdGgpLCBiYXNlSHJlZik7XG5cbiAgICAgIHJldHVybiBnZW4ucHJvY2Vzcyhjb25maWdKc29uKTtcbiAgICB9KSxcblxuICAgIHN3aXRjaE1hcChvdXRwdXQgPT4ge1xuICAgICAgY29uc3QgbWFuaWZlc3QgPSBKU09OLnN0cmluZ2lmeShvdXRwdXQsIG51bGwsIDIpO1xuICAgICAgcmV0dXJuIGhvc3QucmVhZCh3b3JrZXJQYXRoKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAod29ya2VyQ29kZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG1lcmdlKFxuICAgICAgICAgICAgaG9zdC53cml0ZShqb2luKGRpc3RQYXRoLCAnbmdzdy5qc29uJyksIHZpcnR1YWxGcy5zdHJpbmdUb0ZpbGVCdWZmZXIobWFuaWZlc3QpKSxcbiAgICAgICAgICAgIGhvc3Qud3JpdGUoam9pbihkaXN0UGF0aCwgJ25nc3ctd29ya2VyLmpzJyksIHdvcmtlckNvZGUpLFxuICAgICAgICAgICkgYXMgT2JzZXJ2YWJsZTx2b2lkPjtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pLFxuXG4gICAgc3dpdGNoTWFwKCgpID0+IGhvc3QuZXhpc3RzKHNhZmV0eVBhdGgpKSxcbiAgICAvLyBJZiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBoYXMgdGhlIHNhZmV0eSBzY3JpcHQsIGNvcHkgaXQgaW50byB0d28gbG9jYXRpb25zLlxuICAgIHN3aXRjaE1hcChleGlzdHMgPT4ge1xuICAgICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgcmV0dXJuIG9mPHZvaWQ+KHVuZGVmaW5lZCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBob3N0LnJlYWQoc2FmZXR5UGF0aCkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKHNhZmV0eUNvZGUgPT4ge1xuICAgICAgICAgIHJldHVybiBtZXJnZShcbiAgICAgICAgICAgIGhvc3Qud3JpdGUoam9pbihkaXN0UGF0aCwgJ3dvcmtlci1iYXNpYy5taW4uanMnKSwgc2FmZXR5Q29kZSksXG4gICAgICAgICAgICBob3N0LndyaXRlKGpvaW4oZGlzdFBhdGgsICdzYWZldHktd29ya2VyLmpzJyksIHNhZmV0eUNvZGUpLFxuICAgICAgICAgICkgYXMgT2JzZXJ2YWJsZTx2b2lkPjtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pLFxuXG4gICAgLy8gUmVtb3ZlIGFsbCBlbGVtZW50cywgcmVkdWNlIHRoZW0gdG8gYSBzaW5nbGUgZW1pdC5cbiAgICByZWR1Y2UoKCkgPT4ge30pLFxuICApLnRvUHJvbWlzZSgpO1xufVxuIl19