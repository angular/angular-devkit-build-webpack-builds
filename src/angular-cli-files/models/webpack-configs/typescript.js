"use strict";
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const common_tags_1 = require("common-tags");
const webpack_1 = require("@ngtools/webpack");
const SilentError = require('silent-error');
const g = global;
const webpackLoader = g['angularCliIsLocal']
    ? g.angularCliPackages['@ngtools/webpack'].main
    : '@ngtools/webpack';
function _createAotPlugin(wco, options, useMain = true) {
    const { appConfig, root, buildOptions } = wco;
    options.compilerOptions = options.compilerOptions || {};
    if (wco.buildOptions.preserveSymlinks) {
        options.compilerOptions.preserveSymlinks = true;
    }
    // Read the environment, and set it in the compiler host.
    let hostReplacementPaths = {};
    // process environment file replacement
    if (appConfig.environments) {
        if (!appConfig.environmentSource) {
            let migrationMessage = '';
            if ('source' in appConfig.environments) {
                migrationMessage = '\n\n' + common_tags_1.stripIndent `
          A new environmentSource entry replaces the previous source entry inside environments.

          To migrate angular-cli.json follow the example below:

          Before:

          "environments": {
            "source": "environments/environment.ts",
            "dev": "environments/environment.ts",
            "prod": "environments/environment.prod.ts"
          }


          After:

          "environmentSource": "environments/environment.ts",
          "environments": {
            "dev": "environments/environment.ts",
            "prod": "environments/environment.prod.ts"
          }
        `;
            }
            throw new SilentError(`Environment configuration does not contain "environmentSource" entry.${migrationMessage}`);
        }
        if (!(buildOptions.environment in appConfig.environments)) {
            throw new SilentError(`Environment "${buildOptions.environment}" does not exist.`);
        }
        const sourcePath = appConfig.environmentSource;
        const envFile = appConfig.environments[buildOptions.environment];
        hostReplacementPaths = {
            [path.resolve(root, sourcePath)]: path.resolve(root, envFile)
        };
    }
    let i18nInFile = buildOptions.i18nFile
        ? path.resolve(root, buildOptions.i18nFile)
        : undefined;
    const additionalLazyModules = {};
    if (appConfig.lazyModules) {
        for (const lazyModule of appConfig.lazyModules) {
            additionalLazyModules[lazyModule] = path.resolve(root, lazyModule);
        }
    }
    const pluginOptions = Object.assign({ mainPath: useMain ? path.join(root, appConfig.main) : undefined, i18nInFile: i18nInFile, i18nInFormat: buildOptions.i18nFormat, i18nOutFile: buildOptions.i18nOutFile, i18nOutFormat: buildOptions.i18nOutFormat, locale: buildOptions.i18nLocale, platform: appConfig.platform === 'server' ? webpack_1.PLATFORM.Server : webpack_1.PLATFORM.Browser, missingTranslation: buildOptions.i18nMissingTranslation, hostReplacementPaths, sourceMap: buildOptions.sourceMap, additionalLazyModules, nameLazyFiles: buildOptions.namedChunks, forkTypeChecker: buildOptions.forkTypeChecker }, options);
    return new webpack_1.AngularCompilerPlugin(pluginOptions);
}
function getNonAotConfig(wco) {
    const { appConfig, root } = wco;
    const tsConfigPath = path.resolve(root, appConfig.tsConfig);
    return {
        module: { rules: [{ test: /\.ts$/, loader: webpackLoader }] },
        plugins: [_createAotPlugin(wco, { tsConfigPath, skipCodeGeneration: true })]
    };
}
exports.getNonAotConfig = getNonAotConfig;
function getAotConfig(wco) {
    const { root, buildOptions, appConfig } = wco;
    const tsConfigPath = path.resolve(root, appConfig.tsConfig);
    const loaders = [webpackLoader];
    if (buildOptions.buildOptimizer) {
        loaders.unshift({
            loader: '@angular-devkit/build-optimizer/webpack-loader',
            options: { sourceMap: buildOptions.sourceMap }
        });
    }
    const test = /(?:\.ngfactory\.js|\.ngstyle\.js|\.ts)$/;
    return {
        module: { rules: [{ test, use: loaders }] },
        plugins: [_createAotPlugin(wco, { tsConfigPath })]
    };
}
exports.getAotConfig = getAotConfig;
function getNonAotTestConfig(wco) {
    const { root, appConfig } = wco;
    const tsConfigPath = path.resolve(root, appConfig.tsConfig);
    let pluginOptions = { tsConfigPath, skipCodeGeneration: true };
    if (appConfig.polyfills) {
        // TODO: remove singleFileIncludes for 2.0, this is just to support old projects that did not
        // include 'polyfills.ts' in `tsconfig.spec.json'.
        const polyfillsPath = path.resolve(root, appConfig.polyfills);
        pluginOptions.singleFileIncludes = [polyfillsPath];
    }
    return {
        module: { rules: [{ test: /\.ts$/, loader: webpackLoader }] },
        plugins: [_createAotPlugin(wco, pluginOptions, false)]
    };
}
exports.getNonAotTestConfig = getNonAotTestConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZXNjcmlwdC5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvYnVpbGRfd2VicGFjay9zcmMvYW5ndWxhci1jbGktZmlsZXMvbW9kZWxzL3dlYnBhY2stY29uZmlncy90eXBlc2NyaXB0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxpQkFBaUI7QUFDakIsK0RBQStEOztBQUUvRCw2QkFBNkI7QUFDN0IsNkNBQTBDO0FBQzFDLDhDQUkwQjtBQUcxQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFHNUMsTUFBTSxDQUFDLEdBQVEsTUFBTSxDQUFDO0FBQ3RCLE1BQU0sYUFBYSxHQUFXLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixDQUFDLENBQUMsSUFBSTtJQUMvQyxDQUFDLENBQUMsa0JBQWtCLENBQUM7QUFHdkIsMEJBQTBCLEdBQXlCLEVBQUUsT0FBWSxFQUFFLE9BQU8sR0FBRyxJQUFJO0lBQy9FLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxHQUFHLEdBQUcsQ0FBQztJQUM5QyxPQUFPLENBQUMsZUFBZSxHQUFHLE9BQU8sQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDO0lBRXhELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0lBQ2xELENBQUM7SUFFRCx5REFBeUQ7SUFDekQsSUFBSSxvQkFBb0IsR0FBUSxFQUFFLENBQUM7SUFDbkMsdUNBQXVDO0lBQ3ZDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBQzNCLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLGlCQUFp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QUFNLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFNUQsSUFBSSxhQUFhLEdBQVEsRUFBRSxZQUFZLEVBQUUsa0JBQWtCLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFFcEUsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDeEIsNkZBQTZGO1FBQzdGLGtEQUFrRDtRQUNsRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDOUQsYUFBYSxDQUFDLGtCQUFrQixHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELE1BQU0sQ0FBQztRQUNMLE1BQU0sRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLENBQUMsRUFBRTtRQUM3RCxPQUFPLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3ZELENBQUM7QUFDSixDQUFDO0FBakJELGtEQWlCQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlXG4vLyBUT0RPOiBjbGVhbnVwIHRoaXMgZmlsZSwgaXQncyBjb3BpZWQgYXMgaXMgZnJvbSBBbmd1bGFyIENMSS5cblxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHN0cmlwSW5kZW50IH0gZnJvbSAnY29tbW9uLXRhZ3MnO1xuaW1wb3J0IHtcbiAgQW5ndWxhckNvbXBpbGVyUGx1Z2luLFxuICBBbmd1bGFyQ29tcGlsZXJQbHVnaW5PcHRpb25zLFxuICBQTEFURk9STVxufSBmcm9tICdAbmd0b29scy93ZWJwYWNrJztcbmltcG9ydCB7IFdlYnBhY2tDb25maWdPcHRpb25zIH0gZnJvbSAnLi4vYnVpbGQtb3B0aW9ucyc7XG5cbmNvbnN0IFNpbGVudEVycm9yID0gcmVxdWlyZSgnc2lsZW50LWVycm9yJyk7XG5cblxuY29uc3QgZzogYW55ID0gZ2xvYmFsO1xuY29uc3Qgd2VicGFja0xvYWRlcjogc3RyaW5nID0gZ1snYW5ndWxhckNsaUlzTG9jYWwnXVxuICA/IGcuYW5ndWxhckNsaVBhY2thZ2VzWydAbmd0b29scy93ZWJwYWNrJ10ubWFpblxuICA6ICdAbmd0b29scy93ZWJwYWNrJztcblxuXG5mdW5jdGlvbiBfY3JlYXRlQW90UGx1Z2luKHdjbzogV2VicGFja0NvbmZpZ09wdGlvbnMsIG9wdGlvbnM6IGFueSwgdXNlTWFpbiA9IHRydWUpIHtcbiAgY29uc3QgeyBhcHBDb25maWcsIHJvb3QsIGJ1aWxkT3B0aW9ucyB9ID0gd2NvO1xuICBvcHRpb25zLmNvbXBpbGVyT3B0aW9ucyA9IG9wdGlvbnMuY29tcGlsZXJPcHRpb25zIHx8IHt9O1xuXG4gIGlmICh3Y28uYnVpbGRPcHRpb25zLnByZXNlcnZlU3ltbGlua3MpIHtcbiAgICBvcHRpb25zLmNvbXBpbGVyT3B0aW9ucy5wcmVzZXJ2ZVN5bWxpbmtzID0gdHJ1ZTtcbiAgfVxuXG4gIC8vIFJlYWQgdGhlIGVudmlyb25tZW50LCBhbmQgc2V0IGl0IGluIHRoZSBjb21waWxlciBob3N0LlxuICBsZXQgaG9zdFJlcGxhY2VtZW50UGF0aHM6IGFueSA9IHt9O1xuICAvLyBwcm9jZXNzIGVudmlyb25tZW50IGZpbGUgcmVwbGFjZW1lbnRcbiAgaWYgKGFwcENvbmZpZy5lbnZpcm9ubWVudHMpIHtcbiAgICBpZiAoIWFwcENvbmZpZy5lbnZpcm9ubWVudFNvdXJjZSkge1xuICAgICAgbGV0IG1pZ3JhdGlvbk1lc3NhZ2UgPSAnJztcbiAgICAgIGlmICgnc291cmNlJyBpbiBhcHBDb25maWcuZW52aXJvbm1lbnRzKSB7XG4gICAgICAgIG1pZ3JhdGlvbk1lc3NhZ2UgPSAnXFxuXFxuJyArIHN0cmlwSW5kZW50YFxuICAgICAgICAgIEEgbmV3IGVudmlyb25tZW50U291cmNlIGVudHJ5IHJlcGxhY2VzIHRoZSBwcmV2aW91cyBzb3VyY2UgZW50cnkgaW5zaWRlIGVudmlyb25tZW50cy5cblxuICAgICAgICAgIFRvIG1pZ3JhdGUgYW5ndWxhci1jbGkuanNvbiBmb2xsb3cgdGhlIGV4YW1wbGUgYmVsb3c6XG5cbiAgICAgICAgICBCZWZvcmU6XG5cbiAgICAgICAgICBcImVudmlyb25tZW50c1wiOiB7XG4gICAgICAgICAgICBcInNvdXJjZVwiOiBcImVudmlyb25tZW50cy9lbnZpcm9ubWVudC50c1wiLFxuICAgICAgICAgICAgXCJkZXZcIjogXCJlbnZpcm9ubWVudHMvZW52aXJvbm1lbnQudHNcIixcbiAgICAgICAgICAgIFwicHJvZFwiOiBcImVudmlyb25tZW50cy9lbnZpcm9ubWVudC5wcm9kLnRzXCJcbiAgICAgICAgICB9XG5cblxuICAgICAgICAgIEFmdGVyOlxuXG4gICAgICAgICAgXCJlbnZpcm9ubWVudFNvdXJjZVwiOiBcImVudmlyb25tZW50cy9lbnZpcm9ubWVudC50c1wiLFxuICAgICAgICAgIFwiZW52aXJvbm1lbnRzXCI6IHtcbiAgICAgICAgICAgIFwiZGV2XCI6IFwiZW52aXJvbm1lbnRzL2Vudmlyb25tZW50LnRzXCIsXG4gICAgICAgICAgICBcInByb2RcIjogXCJlbnZpcm9ubWVudHMvZW52aXJvbm1lbnQucHJvZC50c1wiXG4gICAgICAgICAgfVxuICAgICAgICBgO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IFNpbGVudEVycm9yKFxuICAgICAgICBgRW52aXJvbm1lbnQgY29uZmlndXJhdGlvbiBkb2VzIG5vdCBjb250YWluIFwiZW52aXJvbm1lbnRTb3VyY2VcIiBlbnRyeS4ke21pZ3JhdGlvbk1lc3NhZ2V9YFxuICAgICAgKTtcblxuICAgIH1cbiAgICBpZiAoIShidWlsZE9wdGlvbnMuZW52aXJvbm1lbnQgYXMgYW55IGluIGFwcENvbmZpZy5lbnZpcm9ubWVudHMpKSB7XG4gICAgICB0aHJvdyBuZXcgU2lsZW50RXJyb3IoYEVudmlyb25tZW50IFwiJHtidWlsZE9wdGlvbnMuZW52aXJvbm1lbnR9XCIgZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc291cmNlUGF0aCA9IGFwcENvbmZpZy5lbnZpcm9ubWVudFNvdXJjZTtcbiAgICBjb25zdCBlbnZGaWxlID0gYXBwQ29uZmlnLmVudmlyb25tZW50c1tidWlsZE9wdGlvbnMuZW52aXJvbm1lbnQgYXMgYW55XTtcblxuICAgIGhvc3RSZXBsYWNlbWVudFBhdGhzID0ge1xuICAgICAgW3BhdGgucmVzb2x2ZShyb290LCBzb3VyY2VQYXRoKV06IHBhdGgucmVzb2x2ZShyb290LCBlbnZGaWxlKVxuICAgIH07XG4gIH1cblxuICBsZXQgaTE4bkluRmlsZSA9IGJ1aWxkT3B0aW9ucy5pMThuRmlsZVxuICAgID8gcGF0aC5yZXNvbHZlKHJvb3QsIGJ1aWxkT3B0aW9ucy5pMThuRmlsZSlcbiAgICA6IHVuZGVmaW5lZDtcblxuICBjb25zdCBhZGRpdGlvbmFsTGF6eU1vZHVsZXM6IHsgW21vZHVsZTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcbiAgaWYgKGFwcENvbmZpZy5sYXp5TW9kdWxlcykge1xuICAgIGZvciAoY29uc3QgbGF6eU1vZHVsZSBvZiBhcHBDb25maWcubGF6eU1vZHVsZXMpIHtcbiAgICAgIGFkZGl0aW9uYWxMYXp5TW9kdWxlc1tsYXp5TW9kdWxlXSA9IHBhdGgucmVzb2x2ZShcbiAgICAgICAgcm9vdCxcbiAgICAgICAgbGF6eU1vZHVsZSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcGx1Z2luT3B0aW9uczogQW5ndWxhckNvbXBpbGVyUGx1Z2luT3B0aW9ucyA9IHtcbiAgICBtYWluUGF0aDogdXNlTWFpbiA/IHBhdGguam9pbihyb290LCBhcHBDb25maWcubWFpbikgOiB1bmRlZmluZWQsXG4gICAgaTE4bkluRmlsZTogaTE4bkluRmlsZSxcbiAgICBpMThuSW5Gb3JtYXQ6IGJ1aWxkT3B0aW9ucy5pMThuRm9ybWF0LFxuICAgIGkxOG5PdXRGaWxlOiBidWlsZE9wdGlvbnMuaTE4bk91dEZpbGUsXG4gICAgaTE4bk91dEZvcm1hdDogYnVpbGRPcHRpb25zLmkxOG5PdXRGb3JtYXQsXG4gICAgbG9jYWxlOiBidWlsZE9wdGlvbnMuaTE4bkxvY2FsZSxcbiAgICBwbGF0Zm9ybTogYXBwQ29uZmlnLnBsYXRmb3JtID09PSAnc2VydmVyJyA/IFBMQVRGT1JNLlNlcnZlciA6IFBMQVRGT1JNLkJyb3dzZXIsXG4gICAgbWlzc2luZ1RyYW5zbGF0aW9uOiBidWlsZE9wdGlvbnMuaTE4bk1pc3NpbmdUcmFuc2xhdGlvbixcbiAgICBob3N0UmVwbGFjZW1lbnRQYXRocyxcbiAgICBzb3VyY2VNYXA6IGJ1aWxkT3B0aW9ucy5zb3VyY2VNYXAsXG4gICAgYWRkaXRpb25hbExhenlNb2R1bGVzLFxuICAgIG5hbWVMYXp5RmlsZXM6IGJ1aWxkT3B0aW9ucy5uYW1lZENodW5rcyxcbiAgICBmb3JrVHlwZUNoZWNrZXI6IGJ1aWxkT3B0aW9ucy5mb3JrVHlwZUNoZWNrZXIsXG4gICAgLi4ub3B0aW9uc1xuICB9O1xuICByZXR1cm4gbmV3IEFuZ3VsYXJDb21waWxlclBsdWdpbihwbHVnaW5PcHRpb25zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE5vbkFvdENvbmZpZyh3Y286IFdlYnBhY2tDb25maWdPcHRpb25zKSB7XG4gIGNvbnN0IHsgYXBwQ29uZmlnLCByb290IH0gPSB3Y287XG4gIGNvbnN0IHRzQ29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZShyb290LCBhcHBDb25maWcudHNDb25maWcpO1xuXG4gIHJldHVybiB7XG4gICAgbW9kdWxlOiB7IHJ1bGVzOiBbeyB0ZXN0OiAvXFwudHMkLywgbG9hZGVyOiB3ZWJwYWNrTG9hZGVyIH1dIH0sXG4gICAgcGx1Z2luczogW19jcmVhdGVBb3RQbHVnaW4od2NvLCB7IHRzQ29uZmlnUGF0aCwgc2tpcENvZGVHZW5lcmF0aW9uOiB0cnVlIH0pXVxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QW90Q29uZmlnKHdjbzogV2VicGFja0NvbmZpZ09wdGlvbnMpIHtcbiAgY29uc3QgeyByb290LCBidWlsZE9wdGlvbnMsIGFwcENvbmZpZyB9ID0gd2NvO1xuICBjb25zdCB0c0NvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUocm9vdCwgYXBwQ29uZmlnLnRzQ29uZmlnKTtcblxuICBjb25zdCBsb2FkZXJzOiBhbnlbXSA9IFt3ZWJwYWNrTG9hZGVyXTtcbiAgaWYgKGJ1aWxkT3B0aW9ucy5idWlsZE9wdGltaXplcikge1xuICAgIGxvYWRlcnMudW5zaGlmdCh7XG4gICAgICBsb2FkZXI6ICdAYW5ndWxhci1kZXZraXQvYnVpbGQtb3B0aW1pemVyL3dlYnBhY2stbG9hZGVyJyxcbiAgICAgIG9wdGlvbnM6IHsgc291cmNlTWFwOiBidWlsZE9wdGlvbnMuc291cmNlTWFwIH1cbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHRlc3QgPSAvKD86XFwubmdmYWN0b3J5XFwuanN8XFwubmdzdHlsZVxcLmpzfFxcLnRzKSQvO1xuXG4gIHJldHVybiB7XG4gICAgbW9kdWxlOiB7IHJ1bGVzOiBbeyB0ZXN0LCB1c2U6IGxvYWRlcnMgfV0gfSxcbiAgICBwbHVnaW5zOiBbX2NyZWF0ZUFvdFBsdWdpbih3Y28sIHsgdHNDb25maWdQYXRoIH0pXVxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Tm9uQW90VGVzdENvbmZpZyh3Y286IFdlYnBhY2tDb25maWdPcHRpb25zKSB7XG4gIGNvbnN0IHsgcm9vdCwgYXBwQ29uZmlnIH0gPSB3Y287XG4gIGNvbnN0IHRzQ29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZShyb290LCBhcHBDb25maWcudHNDb25maWcpO1xuXG4gIGxldCBwbHVnaW5PcHRpb25zOiBhbnkgPSB7IHRzQ29uZmlnUGF0aCwgc2tpcENvZGVHZW5lcmF0aW9uOiB0cnVlIH07XG5cbiAgaWYgKGFwcENvbmZpZy5wb2x5ZmlsbHMpIHtcbiAgICAvLyBUT0RPOiByZW1vdmUgc2luZ2xlRmlsZUluY2x1ZGVzIGZvciAyLjAsIHRoaXMgaXMganVzdCB0byBzdXBwb3J0IG9sZCBwcm9qZWN0cyB0aGF0IGRpZCBub3RcbiAgICAvLyBpbmNsdWRlICdwb2x5ZmlsbHMudHMnIGluIGB0c2NvbmZpZy5zcGVjLmpzb24nLlxuICAgIGNvbnN0IHBvbHlmaWxsc1BhdGggPSBwYXRoLnJlc29sdmUocm9vdCwgYXBwQ29uZmlnLnBvbHlmaWxscyk7XG4gICAgcGx1Z2luT3B0aW9ucy5zaW5nbGVGaWxlSW5jbHVkZXMgPSBbcG9seWZpbGxzUGF0aF07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIG1vZHVsZTogeyBydWxlczogW3sgdGVzdDogL1xcLnRzJC8sIGxvYWRlcjogd2VicGFja0xvYWRlciB9XSB9LFxuICAgIHBsdWdpbnM6IFtfY3JlYXRlQW90UGx1Z2luKHdjbywgcGx1Z2luT3B0aW9ucywgZmFsc2UpXVxuICB9O1xufVxuIl19