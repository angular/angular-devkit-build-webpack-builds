"use strict";
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const common_tags_1 = require("common-tags");
const webpack_1 = require("@ngtools/webpack");
const SilentError = require('silent-error');
const g = global;
const webpackLoader = g['angularCliIsLocal']
    ? g.angularCliPackages['@ngtools/webpack'].main
    : '@ngtools/webpack';
function _createAotPlugin(wco, options, useMain = true) {
    const { appConfig, projectRoot, buildOptions } = wco;
    const appRoot = path.resolve(projectRoot, appConfig.root);
    options.compilerOptions = options.compilerOptions || {};
    if (wco.buildOptions.preserveSymlinks) {
        options.compilerOptions.preserveSymlinks = true;
    }
    // Read the environment, and set it in the compiler host.
    let hostReplacementPaths = {};
    // process environment file replacement
    if (appConfig.environments) {
        if (!appConfig.environmentSource) {
            let migrationMessage = '';
            if ('source' in appConfig.environments) {
                migrationMessage = '\n\n' + common_tags_1.stripIndent `
          A new environmentSource entry replaces the previous source entry inside environments.

          To migrate angular-cli.json follow the example below:

          Before:

          "environments": {
            "source": "environments/environment.ts",
            "dev": "environments/environment.ts",
            "prod": "environments/environment.prod.ts"
          }


          After:

          "environmentSource": "environments/environment.ts",
          "environments": {
            "dev": "environments/environment.ts",
            "prod": "environments/environment.prod.ts"
          }
        `;
            }
            throw new SilentError(`Environment configuration does not contain "environmentSource" entry.${migrationMessage}`);
        }
        if (!(buildOptions.environment in appConfig.environments)) {
            throw new SilentError(`Environment "${buildOptions.environment}" does not exist.`);
        }
        const sourcePath = appConfig.environmentSource;
        const envFile = appConfig.environments[buildOptions.environment];
        hostReplacementPaths = {
            [path.resolve(appRoot, sourcePath)]: path.resolve(appRoot, envFile)
        };
    }
    let i18nInFile = buildOptions.i18nFile
        ? path.resolve(appRoot, buildOptions.i18nFile)
        : undefined;
    const additionalLazyModules = {};
    if (appConfig.lazyModules) {
        for (const lazyModule of appConfig.lazyModules) {
            additionalLazyModules[lazyModule] = path.resolve(projectRoot, appConfig.root, lazyModule);
        }
    }
    const pluginOptions = Object.assign({ mainPath: useMain ? path.join(projectRoot, appConfig.root, appConfig.main) : undefined, i18nInFile: i18nInFile, i18nInFormat: buildOptions.i18nFormat, i18nOutFile: buildOptions.i18nOutFile, i18nOutFormat: buildOptions.i18nOutFormat, locale: buildOptions.i18nLocale, platform: appConfig.platform === 'server' ? webpack_1.PLATFORM.Server : webpack_1.PLATFORM.Browser, missingTranslation: buildOptions.i18nMissingTranslation, hostReplacementPaths, sourceMap: buildOptions.sourceMap, additionalLazyModules, nameLazyFiles: buildOptions.namedChunks, forkTypeChecker: buildOptions.forkTypeChecker }, options);
    return new webpack_1.AngularCompilerPlugin(pluginOptions);
}
function getNonAotConfig(wco) {
    const { appConfig, projectRoot } = wco;
    const tsConfigPath = path.resolve(projectRoot, appConfig.root, appConfig.tsConfig);
    return {
        module: { rules: [{ test: /\.ts$/, loader: webpackLoader }] },
        plugins: [_createAotPlugin(wco, { tsConfigPath, skipCodeGeneration: true })]
    };
}
exports.getNonAotConfig = getNonAotConfig;
function getAotConfig(wco) {
    const { projectRoot, buildOptions, appConfig } = wco;
    const tsConfigPath = path.resolve(projectRoot, appConfig.root, appConfig.tsConfig);
    const loaders = [webpackLoader];
    if (buildOptions.buildOptimizer) {
        loaders.unshift({
            loader: '@angular-devkit/build-optimizer/webpack-loader',
            options: { sourceMap: buildOptions.sourceMap }
        });
    }
    const test = /(?:\.ngfactory\.js|\.ngstyle\.js|\.ts)$/;
    return {
        module: { rules: [{ test, use: loaders }] },
        plugins: [_createAotPlugin(wco, { tsConfigPath })]
    };
}
exports.getAotConfig = getAotConfig;
function getNonAotTestConfig(wco) {
    const { projectRoot, appConfig } = wco;
    const tsConfigPath = path.resolve(projectRoot, appConfig.root, appConfig.tsConfig);
    let pluginOptions = { tsConfigPath, skipCodeGeneration: true };
    if (appConfig.polyfills) {
        // TODO: remove singleFileIncludes for 2.0, this is just to support old projects that did not
        // include 'polyfills.ts' in `tsconfig.spec.json'.
        const polyfillsPath = path.resolve(projectRoot, appConfig.root, appConfig.polyfills);
        pluginOptions.singleFileIncludes = [polyfillsPath];
    }
    return {
        module: { rules: [{ test: /\.ts$/, loader: webpackLoader }] },
        plugins: [_createAotPlugin(wco, pluginOptions, false)]
    };
}
exports.getNonAotTestConfig = getNonAotTestConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZXNjcmlwdC5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvYnVpbGRfd2VicGFjay9zcmMvYW5ndWxhci1jbGktZmlsZXMvbW9kZWxzL3dlYnBhY2stY29uZmlncy90eXBlc2NyaXB0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxpQkFBaUI7QUFDakIsK0RBQStEOztBQUUvRCw2QkFBNkI7QUFDN0IsNkNBQTBDO0FBQzFDLDhDQUkwQjtBQUcxQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFHNUMsTUFBTSxDQUFDLEdBQVEsTUFBTSxDQUFDO0FBQ3RCLE1BQU0sYUFBYSxHQUFXLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixDQUFDLENBQUMsSUFBSTtJQUMvQyxDQUFDLENBQUMsa0JBQWtCLENBQUM7QUFHdkIsMEJBQTBCLEdBQXlCLEVBQUUsT0FBWSxFQUFFLE9BQU8sR0FBRyxJQUFJO0lBQy9FLE1BQU0sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxHQUFHLEdBQUcsQ0FBQztJQUNyRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUQsT0FBTyxDQUFDLGVBQWUsR0FBRyxPQUFPLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQztJQUV4RCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztRQUN0QyxPQUFPLENBQUMsZUFBZSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztJQUNsRCxDQUFDO0lBRUQseURBQXlEO0lBQ3pELElBQUksb0JBQW9CLEdBQVEsRUFBRSxDQUFDO0lBQ25DLHVDQUF1QztJQUN2QyxFQUFFLENBQUMs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QkFBZ0IsQ0FBQyxHQUFHLEVBQUUsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0tBQ25ELENBQUM7QUFDSixDQUFDO0FBbEJELG9DQWtCQztBQUVELDZCQUFvQyxHQUF5QjtJQUMzRCxNQUFNLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxHQUFHLEdBQUcsQ0FBQztJQUN2QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUVuRixJQUFJLGFBQWEsR0FBUSxFQUFFLFlBQVksRUFBRSxrQkFBa0IsRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUVwRSxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUN4Qiw2RkFBNkY7UUFDN0Ysa0RBQWtEO1FBQ2xELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3JGLGFBQWEsQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxNQUFNLENBQUM7UUFDTCxNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxDQUFDLEVBQUU7UUFDN0QsT0FBTyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUN2RCxDQUFDO0FBQ0osQ0FBQztBQWpCRCxrREFpQkMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZVxuLy8gVE9ETzogY2xlYW51cCB0aGlzIGZpbGUsIGl0J3MgY29waWVkIGFzIGlzIGZyb20gQW5ndWxhciBDTEkuXG5cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzdHJpcEluZGVudCB9IGZyb20gJ2NvbW1vbi10YWdzJztcbmltcG9ydCB7XG4gIEFuZ3VsYXJDb21waWxlclBsdWdpbixcbiAgQW5ndWxhckNvbXBpbGVyUGx1Z2luT3B0aW9ucyxcbiAgUExBVEZPUk1cbn0gZnJvbSAnQG5ndG9vbHMvd2VicGFjayc7XG5pbXBvcnQgeyBXZWJwYWNrQ29uZmlnT3B0aW9ucyB9IGZyb20gJy4uL2J1aWxkLW9wdGlvbnMnO1xuXG5jb25zdCBTaWxlbnRFcnJvciA9IHJlcXVpcmUoJ3NpbGVudC1lcnJvcicpO1xuXG5cbmNvbnN0IGc6IGFueSA9IGdsb2JhbDtcbmNvbnN0IHdlYnBhY2tMb2FkZXI6IHN0cmluZyA9IGdbJ2FuZ3VsYXJDbGlJc0xvY2FsJ11cbiAgPyBnLmFuZ3VsYXJDbGlQYWNrYWdlc1snQG5ndG9vbHMvd2VicGFjayddLm1haW5cbiAgOiAnQG5ndG9vbHMvd2VicGFjayc7XG5cblxuZnVuY3Rpb24gX2NyZWF0ZUFvdFBsdWdpbih3Y286IFdlYnBhY2tDb25maWdPcHRpb25zLCBvcHRpb25zOiBhbnksIHVzZU1haW4gPSB0cnVlKSB7XG4gIGNvbnN0IHsgYXBwQ29uZmlnLCBwcm9qZWN0Um9vdCwgYnVpbGRPcHRpb25zIH0gPSB3Y287XG4gIGNvbnN0IGFwcFJvb3QgPSBwYXRoLnJlc29sdmUocHJvamVjdFJvb3QsIGFwcENvbmZpZy5yb290KTtcbiAgb3B0aW9ucy5jb21waWxlck9wdGlvbnMgPSBvcHRpb25zLmNvbXBpbGVyT3B0aW9ucyB8fCB7fTtcblxuICBpZiAod2NvLmJ1aWxkT3B0aW9ucy5wcmVzZXJ2ZVN5bWxpbmtzKSB7XG4gICAgb3B0aW9ucy5jb21waWxlck9wdGlvbnMucHJlc2VydmVTeW1saW5rcyA9IHRydWU7XG4gIH1cblxuICAvLyBSZWFkIHRoZSBlbnZpcm9ubWVudCwgYW5kIHNldCBpdCBpbiB0aGUgY29tcGlsZXIgaG9zdC5cbiAgbGV0IGhvc3RSZXBsYWNlbWVudFBhdGhzOiBhbnkgPSB7fTtcbiAgLy8gcHJvY2VzcyBlbnZpcm9ubWVudCBmaWxlIHJlcGxhY2VtZW50XG4gIGlmIChhcHBDb25maWcuZW52aXJvbm1lbnRzKSB7XG4gICAgaWYgKCFhcHBDb25maWcuZW52aXJvbm1lbnRTb3VyY2UpIHtcbiAgICAgIGxldCBtaWdyYXRpb25NZXNzYWdlID0gJyc7XG4gICAgICBpZiAoJ3NvdXJjZScgaW4gYXBwQ29uZmlnLmVudmlyb25tZW50cykge1xuICAgICAgICBtaWdyYXRpb25NZXNzYWdlID0gJ1xcblxcbicgKyBzdHJpcEluZGVudGBcbiAgICAgICAgICBBIG5ldyBlbnZpcm9ubWVudFNvdXJjZSBlbnRyeSByZXBsYWNlcyB0aGUgcHJldmlvdXMgc291cmNlIGVudHJ5IGluc2lkZSBlbnZpcm9ubWVudHMuXG5cbiAgICAgICAgICBUbyBtaWdyYXRlIGFuZ3VsYXItY2xpLmpzb24gZm9sbG93IHRoZSBleGFtcGxlIGJlbG93OlxuXG4gICAgICAgICAgQmVmb3JlOlxuXG4gICAgICAgICAgXCJlbnZpcm9ubWVudHNcIjoge1xuICAgICAgICAgICAgXCJzb3VyY2VcIjogXCJlbnZpcm9ubWVudHMvZW52aXJvbm1lbnQudHNcIixcbiAgICAgICAgICAgIFwiZGV2XCI6IFwiZW52aXJvbm1lbnRzL2Vudmlyb25tZW50LnRzXCIsXG4gICAgICAgICAgICBcInByb2RcIjogXCJlbnZpcm9ubWVudHMvZW52aXJvbm1lbnQucHJvZC50c1wiXG4gICAgICAgICAgfVxuXG5cbiAgICAgICAgICBBZnRlcjpcblxuICAgICAgICAgIFwiZW52aXJvbm1lbnRTb3VyY2VcIjogXCJlbnZpcm9ubWVudHMvZW52aXJvbm1lbnQudHNcIixcbiAgICAgICAgICBcImVudmlyb25tZW50c1wiOiB7XG4gICAgICAgICAgICBcImRldlwiOiBcImVudmlyb25tZW50cy9lbnZpcm9ubWVudC50c1wiLFxuICAgICAgICAgICAgXCJwcm9kXCI6IFwiZW52aXJvbm1lbnRzL2Vudmlyb25tZW50LnByb2QudHNcIlxuICAgICAgICAgIH1cbiAgICAgICAgYDtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBTaWxlbnRFcnJvcihcbiAgICAgICAgYEVudmlyb25tZW50IGNvbmZpZ3VyYXRpb24gZG9lcyBub3QgY29udGFpbiBcImVudmlyb25tZW50U291cmNlXCIgZW50cnkuJHttaWdyYXRpb25NZXNzYWdlfWBcbiAgICAgICk7XG5cbiAgICB9XG4gICAgaWYgKCEoYnVpbGRPcHRpb25zLmVudmlyb25tZW50IGFzIGFueSBpbiBhcHBDb25maWcuZW52aXJvbm1lbnRzKSkge1xuICAgICAgdGhyb3cgbmV3IFNpbGVudEVycm9yKGBFbnZpcm9ubWVudCBcIiR7YnVpbGRPcHRpb25zLmVudmlyb25tZW50fVwiIGRvZXMgbm90IGV4aXN0LmApO1xuICAgIH1cblxuICAgIGNvbnN0IHNvdXJjZVBhdGggPSBhcHBDb25maWcuZW52aXJvbm1lbnRTb3VyY2U7XG4gICAgY29uc3QgZW52RmlsZSA9IGFwcENvbmZpZy5lbnZpcm9ubWVudHNbYnVpbGRPcHRpb25zLmVudmlyb25tZW50IGFzIGFueV07XG5cbiAgICBob3N0UmVwbGFjZW1lbnRQYXRocyA9IHtcbiAgICAgIFtwYXRoLnJlc29sdmUoYXBwUm9vdCwgc291cmNlUGF0aCldOiBwYXRoLnJlc29sdmUoYXBwUm9vdCwgZW52RmlsZSlcbiAgICB9O1xuICB9XG5cbiAgbGV0IGkxOG5JbkZpbGUgPSBidWlsZE9wdGlvbnMuaTE4bkZpbGVcbiAgICA/IHBhdGgucmVzb2x2ZShhcHBSb290LCBidWlsZE9wdGlvbnMuaTE4bkZpbGUpXG4gICAgOiB1bmRlZmluZWQ7XG5cbiAgY29uc3QgYWRkaXRpb25hbExhenlNb2R1bGVzOiB7IFttb2R1bGU6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG4gIGlmIChhcHBDb25maWcubGF6eU1vZHVsZXMpIHtcbiAgICBmb3IgKGNvbnN0IGxhenlNb2R1bGUgb2YgYXBwQ29uZmlnLmxhenlNb2R1bGVzKSB7XG4gICAgICBhZGRpdGlvbmFsTGF6eU1vZHVsZXNbbGF6eU1vZHVsZV0gPSBwYXRoLnJlc29sdmUoXG4gICAgICAgIHByb2plY3RSb290LFxuICAgICAgICBhcHBDb25maWcucm9vdCxcbiAgICAgICAgbGF6eU1vZHVsZSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcGx1Z2luT3B0aW9uczogQW5ndWxhckNvbXBpbGVyUGx1Z2luT3B0aW9ucyA9IHtcbiAgICBtYWluUGF0aDogdXNlTWFpbiA/IHBhdGguam9pbihwcm9qZWN0Um9vdCwgYXBwQ29uZmlnLnJvb3QsIGFwcENvbmZpZy5tYWluKSA6IHVuZGVmaW5lZCxcbiAgICBpMThuSW5GaWxlOiBpMThuSW5GaWxlLFxuICAgIGkxOG5JbkZvcm1hdDogYnVpbGRPcHRpb25zLmkxOG5Gb3JtYXQsXG4gICAgaTE4bk91dEZpbGU6IGJ1aWxkT3B0aW9ucy5pMThuT3V0RmlsZSxcbiAgICBpMThuT3V0Rm9ybWF0OiBidWlsZE9wdGlvbnMuaTE4bk91dEZvcm1hdCxcbiAgICBsb2NhbGU6IGJ1aWxkT3B0aW9ucy5pMThuTG9jYWxlLFxuICAgIHBsYXRmb3JtOiBhcHBDb25maWcucGxhdGZvcm0gPT09ICdzZXJ2ZXInID8gUExBVEZPUk0uU2VydmVyIDogUExBVEZPUk0uQnJvd3NlcixcbiAgICBtaXNzaW5nVHJhbnNsYXRpb246IGJ1aWxkT3B0aW9ucy5pMThuTWlzc2luZ1RyYW5zbGF0aW9uLFxuICAgIGhvc3RSZXBsYWNlbWVudFBhdGhzLFxuICAgIHNvdXJjZU1hcDogYnVpbGRPcHRpb25zLnNvdXJjZU1hcCxcbiAgICBhZGRpdGlvbmFsTGF6eU1vZHVsZXMsXG4gICAgbmFtZUxhenlGaWxlczogYnVpbGRPcHRpb25zLm5hbWVkQ2h1bmtzLFxuICAgIGZvcmtUeXBlQ2hlY2tlcjogYnVpbGRPcHRpb25zLmZvcmtUeXBlQ2hlY2tlcixcbiAgICAuLi5vcHRpb25zXG4gIH07XG4gIHJldHVybiBuZXcgQW5ndWxhckNvbXBpbGVyUGx1Z2luKHBsdWdpbk9wdGlvbnMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Tm9uQW90Q29uZmlnKHdjbzogV2VicGFja0NvbmZpZ09wdGlvbnMpIHtcbiAgY29uc3QgeyBhcHBDb25maWcsIHByb2plY3RSb290IH0gPSB3Y287XG4gIGNvbnN0IHRzQ29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9qZWN0Um9vdCwgYXBwQ29uZmlnLnJvb3QsIGFwcENvbmZpZy50c0NvbmZpZyk7XG5cbiAgcmV0dXJuIHtcbiAgICBtb2R1bGU6IHsgcnVsZXM6IFt7IHRlc3Q6IC9cXC50cyQvLCBsb2FkZXI6IHdlYnBhY2tMb2FkZXIgfV0gfSxcbiAgICBwbHVnaW5zOiBbX2NyZWF0ZUFvdFBsdWdpbih3Y28sIHsgdHNDb25maWdQYXRoLCBza2lwQ29kZUdlbmVyYXRpb246IHRydWUgfSldXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBb3RDb25maWcod2NvOiBXZWJwYWNrQ29uZmlnT3B0aW9ucykge1xuICBjb25zdCB7IHByb2plY3RSb290LCBidWlsZE9wdGlvbnMsIGFwcENvbmZpZyB9ID0gd2NvO1xuICBjb25zdCB0c0NvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUocHJvamVjdFJvb3QsIGFwcENvbmZpZy5yb290LCBhcHBDb25maWcudHNDb25maWcpO1xuXG4gIGNvbnN0IGxvYWRlcnM6IGFueVtdID0gW3dlYnBhY2tMb2FkZXJdO1xuICBpZiAoYnVpbGRPcHRpb25zLmJ1aWxkT3B0aW1pemVyKSB7XG4gICAgbG9hZGVycy51bnNoaWZ0KHtcbiAgICAgIGxvYWRlcjogJ0Bhbmd1bGFyLWRldmtpdC9idWlsZC1vcHRpbWl6ZXIvd2VicGFjay1sb2FkZXInLFxuICAgICAgb3B0aW9uczogeyBzb3VyY2VNYXA6IGJ1aWxkT3B0aW9ucy5zb3VyY2VNYXAgfVxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgdGVzdCA9IC8oPzpcXC5uZ2ZhY3RvcnlcXC5qc3xcXC5uZ3N0eWxlXFwuanN8XFwudHMpJC87XG5cbiAgcmV0dXJuIHtcbiAgICBtb2R1bGU6IHsgcnVsZXM6IFt7IHRlc3QsIHVzZTogbG9hZGVycyB9XSB9LFxuICAgIHBsdWdpbnM6IFtfY3JlYXRlQW90UGx1Z2luKHdjbywgeyB0c0NvbmZpZ1BhdGggfSldXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXROb25Bb3RUZXN0Q29uZmlnKHdjbzogV2VicGFja0NvbmZpZ09wdGlvbnMpIHtcbiAgY29uc3QgeyBwcm9qZWN0Um9vdCwgYXBwQ29uZmlnIH0gPSB3Y287XG4gIGNvbnN0IHRzQ29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9qZWN0Um9vdCwgYXBwQ29uZmlnLnJvb3QsIGFwcENvbmZpZy50c0NvbmZpZyk7XG5cbiAgbGV0IHBsdWdpbk9wdGlvbnM6IGFueSA9IHsgdHNDb25maWdQYXRoLCBza2lwQ29kZUdlbmVyYXRpb246IHRydWUgfTtcblxuICBpZiAoYXBwQ29uZmlnLnBvbHlmaWxscykge1xuICAgIC8vIFRPRE86IHJlbW92ZSBzaW5nbGVGaWxlSW5jbHVkZXMgZm9yIDIuMCwgdGhpcyBpcyBqdXN0IHRvIHN1cHBvcnQgb2xkIHByb2plY3RzIHRoYXQgZGlkIG5vdFxuICAgIC8vIGluY2x1ZGUgJ3BvbHlmaWxscy50cycgaW4gYHRzY29uZmlnLnNwZWMuanNvbicuXG4gICAgY29uc3QgcG9seWZpbGxzUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9qZWN0Um9vdCwgYXBwQ29uZmlnLnJvb3QsIGFwcENvbmZpZy5wb2x5ZmlsbHMpO1xuICAgIHBsdWdpbk9wdGlvbnMuc2luZ2xlRmlsZUluY2x1ZGVzID0gW3BvbHlmaWxsc1BhdGhdO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBtb2R1bGU6IHsgcnVsZXM6IFt7IHRlc3Q6IC9cXC50cyQvLCBsb2FkZXI6IHdlYnBhY2tMb2FkZXIgfV0gfSxcbiAgICBwbHVnaW5zOiBbX2NyZWF0ZUFvdFBsdWdpbih3Y28sIHBsdWdpbk9wdGlvbnMsIGZhbHNlKV1cbiAgfTtcbn1cbiJdfQ==